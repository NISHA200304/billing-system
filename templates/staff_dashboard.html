<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Dashboard - Hospital Billing</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
#wrapper.toggled #sidebar-wrapper { margin-left: -250px; }
#sidebar-wrapper { width: 250px; transition: margin 0.3s; }
.table-wrapper { max-height: 400px; overflow-y: auto; }
.bill-box { background:#f8f9fa; padding:15px; border-radius:8px; min-height:220px; }
.action-btns { display:flex; gap:8px; }
</style>
</head>

<body>
<div class="d-flex" id="wrapper">

<!-- SIDEBAR -->
<div class="border-end bg-light" id="sidebar-wrapper">
    <div class="sidebar-heading text-center py-4 fs-4 fw-bold text-primary">Staff Panel</div>
    <div class="list-group list-group-flush">
        <a href="{{ url_for('staff_dashboard') }}" class="list-group-item list-group-item-action p-3">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
        </a>
        <a href="{{ url_for('logout') }}" class="list-group-item list-group-item-action p-3">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
        </a>
    </div>
</div>

<div id="page-content-wrapper" class="w-100">

<!-- NAVBAR -->
<nav class="navbar navbar-light bg-light border-bottom">
    <div class="container-fluid position-relative">
        <button class="btn btn-primary position-absolute ms-3" id="sidebarToggle">
            <i class="bi bi-list"></i>
        </button>
        <span class="fs-4 fw-semibold d-block text-center w-100">Staff Dashboard</span>
    </div>
</nav>

<div class="container-fluid px-4 mt-4">

<!-- ADD PATIENT -->
<div class="card mb-4 shadow-sm">
<div class="card-header bg-success text-white">Add New Patient</div>
<div class="card-body">
<form id="addPatientForm">
<div class="row g-3">
    <div class="col-md-3"><input class="form-control" placeholder="Full Name" required></div>
    <div class="col-md-2"><input type="number" class="form-control" placeholder="Age" required></div>
    <div class="col-md-2">
        <select class="form-select" required>
            <option value="">Gender</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
        </select>
    </div>
    <div class="col-md-2"><input class="form-control" placeholder="Treatment (comma-separated)" required></div>
    <div class="col-md-2"><input class="form-control" placeholder="Room Type (comma-separated)" required></div>
    <div class="col-md-1"><input type="number" class="form-control" placeholder="Days" required></div>
    <div class="col-md-2"><input type="date" class="form-control" required></div>
</div>
<div class="text-end mt-3">
    <button class="btn btn-success">
        <i class="bi bi-person-plus"></i> Add Patient
    </button>
</div>
</form>
</div>
</div>

<div class="row">

<!-- PATIENT LIST -->
<!-- PATIENT LIST -->
<div class="col-lg-8">
<div class="card shadow-sm">
<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <span>Patients</span>
    <input type="text" class="form-control w-25" id="patientFilter" placeholder="Search by name">
</div>
<div class="card-body table-wrapper">
<table class="table table-hover">
<thead class="table-light">
<tr>
<th>#</th>
<th>Name</th>
<th>Treatment</th>
<th>Room</th>
<th>Days</th>
<th>Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="patientTable"></tbody>
</table>
</div>
</div>
</div>


<!-- BILL DISPLAY -->
<div class="col-lg-4">
<div class="card shadow-sm">
<div class="card-header bg-success text-white">Generated Bill</div>

<div class="card-body bill-box" id="billBox">
<p class="text-muted">Click <strong>Generate Bill</strong> for a patient</p>
</div>

<div class="card-footer text-end">
<button class="btn btn-info" id="downloadBillBtn">
    <i class="bi bi-download"></i> Download PDF
</button>
</div>

</div>
</div>

</div>
</div>
</div>

<!-- UPDATE MODAL -->
<div class="modal fade" id="updatePatientModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header bg-warning">
<h5 class="modal-title">Update Patient</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="updatePatientForm">
<input type="hidden" id="updatePatientId">
<input id="updateName" class="form-control mb-2" required>
<input id="updateTreatment" class="form-control mb-2" required>
<input id="updateRoom" class="form-control mb-2" required>
<input id="updateDays" type="number" class="form-control mb-2" required>
<input id="updateDate" type="date" class="form-control mb-2" required>
<div class="text-end">
    <button class="btn btn-warning">Update</button>
</div>
</form>
</div>
</div>
</div>
</div>

<!-- LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const patientTable = document.getElementById("patientTable");
const billBox = document.getElementById("billBox");
const downloadBtn = document.getElementById("downloadBillBtn");
const updateModal = new bootstrap.Modal(document.getElementById("updatePatientModal"));

const updatePatientId = document.getElementById("updatePatientId");
const updateName = document.getElementById("updateName");
const updateTreatment = document.getElementById("updateTreatment");
const updateRoom = document.getElementById("updateRoom");
const updateDays = document.getElementById("updateDays");
const updateDate = document.getElementById("updateDate");

sidebarToggle.onclick = () =>
document.getElementById("wrapper").classList.toggle("toggled");

/* FETCH PATIENTS */
function fetchPatients(){
fetch("/patient/get_all")
.then(res=>res.json())
.then(data=>{
patientTable.innerHTML="";
data.forEach((p,i)=>{
patientTable.innerHTML+=`
<tr data-id="${p.id}">
<td>${i+1}</td>
<td>${p.name}</td>
<td>${p.treatment}</td>
<td>${p.room}</td>
<td>${p.no_of_days}</td>
<td>${p.date}</td>
<td>
<div class="action-btns">
<button class="btn btn-sm btn-warning updateBtn">
<i class="bi bi-pencil"></i> Update
</button>
<button class="btn btn-sm btn-success" onclick="generateBill('${p.id}')">
<i class="bi bi-receipt"></i> Generate Bill
</button>
</div>
</td>
</tr>`;
});
});
}
fetchPatients();

/* PATIENT SEARCH/FILTER */
const patientFilter = document.getElementById("patientFilter");
patientFilter.addEventListener("keyup", () => {
    const filter = patientFilter.value.toLowerCase();
    document.querySelectorAll("#patientTable tr").forEach(row => {
        const name = row.children[1].innerText.toLowerCase();
        const treatment = row.children[2].innerText.toLowerCase(); // Optional: include treatment
        row.style.display = (name.includes(filter) || treatment.includes(filter)) ? "" : "none";
    });
});


/* ADD PATIENT */
addPatientForm.onsubmit = e => {
e.preventDefault();

const inputs = addPatientForm.querySelectorAll("input, select");

fetch("/patient/add", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
name: inputs[0].value,
age: inputs[1].value,
gender: inputs[2].value,
treatment: inputs[3].value,
room: inputs[4].value,
no_of_days: inputs[5].value,
date: inputs[6].value
})
})
.then(res => res.json())
.then(() => {
addPatientForm.reset();
fetchPatients();
});
};


/* RESTORE UPDATE BUTTON CLICK */
patientTable.addEventListener("click", e => {
const btn = e.target.closest(".updateBtn");
if(!btn) return;

const row = btn.closest("tr");

updatePatientId.value = row.dataset.id;
updateName.value = row.children[1].innerText;
updateTreatment.value = row.children[2].innerText;
updateRoom.value = row.children[3].innerText;
updateDays.value = row.children[4].innerText;
updateDate.value = row.children[5].innerText;

updateModal.show();
});

/* UPDATE PATIENT SUBMIT */
document.getElementById("updatePatientForm").onsubmit = e => {
e.preventDefault();

fetch(`/patient/update/${updatePatientId.value}`, {
method: "PUT",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
name: updateName.value,
treatment: updateTreatment.value,
room: updateRoom.value,
no_of_days: updateDays.value,
date: updateDate.value
})
})
.then(res => res.json())
.then(() => {
updateModal.hide();
fetchPatients();
});
};

/* GENERATE BILL */
function generateBill(patientId){
fetch(`/billing/calculate/${patientId}`)
.then(res=>res.json())
.then(data=>{
if(data.error){
billBox.innerHTML=`<p class="text-danger">${data.error}</p>`;
return;
}

let html = `<h6 class="text-center">ðŸ§¾ Generated Bill</h6><hr>`;
html += `<p><strong>Patient Name :</strong> ${data.patient}</p>`;

data.treatments.forEach(t=>{
html += `<p><strong>Treatment :</strong> ${t.treatment}</p>`;
html += `<p><strong>Cost :</strong> â‚¹${t.treatment_cost}</p>`;
html += `<p><strong>Room :</strong> ${t.room_type}</p>`;
});

html += `<p><strong>No. of Days :</strong> ${data.days}</p>`;
html += `<hr><h6 class="text-success"><strong>Total Cost :</strong> â‚¹${data.total}</h6>`;
billBox.innerHTML = html;
});
}

/* DOWNLOAD PDF */
downloadBtn.onclick = () => {
if(billBox.innerText.includes("Generate Bill")){
alert("Please generate a bill first");
return;
}

html2canvas(billBox).then(canvas=>{
const imgData = canvas.toDataURL("image/png");
const { jsPDF } = window.jspdf;
const pdf = new jsPDF("p","mm","a4");

const pdfWidth = pdf.internal.pageSize.getWidth();
const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

pdf.addImage(imgData, "PNG", 0, 10, pdfWidth, pdfHeight);
pdf.save("Patient_Bill.pdf");
});
};
</script>
