<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management - Hospital Billing</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        #wrapper.toggled #sidebar-wrapper { margin-left: -250px; }
        #sidebar-wrapper { width: 250px; transition: margin 0.3s; }
        .card { height: 100%; }
        #sidebarToggle { margin-left: 15px; }
        .table-wrapper { max-height: 400px; overflow-y: auto; }
        .back-btn { margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="border-end bg-light" id="sidebar-wrapper">
        <div class="sidebar-heading text-center py-4 fs-4 fw-bold text-primary">
            Hospital Admin
        </div>
        <div class="list-group list-group-flush">
            <a href="{{ url_for('staff_management') }}" class="list-group-item list-group-item-action list-group-item-light p-3">
                <i class="bi bi-people-fill me-2"></i> Staff Management
            </a>
            <a href="{{ url_for('patient_management') }}" class="list-group-item list-group-item-action list-group-item-light p-3">
                <i class="bi bi-person-lines-fill me-2"></i> Patient Management
            </a>
            <a href="{{ url_for('billing_structure') }}" class="list-group-item list-group-item-action list-group-item-light p-3">
                <i class="bi bi-receipt-cutoff me-2"></i> Billing Structure
            </a>
            <a href="{{ url_for('logout') }}" class="list-group-item list-group-item-action list-group-item-light p-3">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
            </a>
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper" class="w-100">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid position-relative">
                <button class="btn btn-primary position-absolute start-0" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <span class="fs-4 fw-semibold d-block text-center w-100">Staff Management</span>
            </div>
        </nav>

        <div class="container-fluid px-4 mt-4">
            <!-- Back Button -->
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary back-btn"><i class="bi bi-arrow-left me-2"></i> Back to Dashboard</a>

            <!-- Add Staff Form -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">Add New Staff</div>
                <div class="card-body">
                    <form id="addStaffForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="Full Name" required>
                            </div>
                            <div class="col-md-4">
                                <input type="email" class="form-control" placeholder="Email" required>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="Role (e.g., Doctor/Nurse)" required>
                            </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button type="submit" class="btn btn-success">Add Staff</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Staff List Table -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>All Staff</span>
                    <input type="text" class="form-control w-25" id="staffFilter" placeholder="Filter by name">
                </div>
                <div class="card-body table-wrapper">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTable">
                            <!-- Rows dynamically loaded from Firestore -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Staff Modal -->
<div class="modal fade" id="updateStaffModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Update Staff</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="updateStaffForm">
          <input type="hidden" id="updateStaffId">
          <div class="mb-3">
            <input type="text" class="form-control" id="updateStaffName" placeholder="Full Name" required>
          </div>
          <div class="mb-3">
            <input type="email" class="form-control" id="updateStaffEmail" placeholder="Email" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" id="updateStaffRole" placeholder="Role" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const staffTable = document.getElementById("staffTable");

    // Fetch all staff and render
    const fetchStaff = () => {
        fetch("/staff/get_all")
        .then(res => res.json())
        .then(data => {
            staffTable.innerHTML = "";
            data.forEach((staff, index) => {
                staffTable.innerHTML += `
                    <tr data-id="${staff.id}">
                        <td>${index+1}</td>
                        <td>${staff.name}</td>
                        <td>${staff.email}</td>
                        <td>${staff.role}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1 updateBtn">Update</button>
                            <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
                        </td>
                    </tr>`;
            });
        });
    };
    fetchStaff();

    // Add staff
    document.getElementById("addStaffForm").addEventListener("submit", e => {
        e.preventDefault();
        const name = e.target[0].value;
        const email = e.target[1].value;
        const role = e.target[2].value;

        fetch("/staff/add", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({name,email,role})
        }).then(() => {
            e.target.reset();
            fetchStaff();
        });
    });

    // Delete staff
    staffTable.addEventListener("click", e => {
        if (e.target.classList.contains("deleteBtn")) {
            const staffId = e.target.closest("tr").dataset.id;
            if(confirm("Are you sure to delete this staff?")) {
                fetch(`/staff/delete/${staffId}`, {method: "DELETE"})
                .then(() => fetchStaff());
            }
        }
    });

    // Open Update Modal
    staffTable.addEventListener("click", e => {
        if (e.target.classList.contains("updateBtn")) {
            const tr = e.target.closest("tr");
            document.getElementById("updateStaffId").value = tr.dataset.id;
            document.getElementById("updateStaffName").value = tr.cells[1].textContent;
            document.getElementById("updateStaffEmail").value = tr.cells[2].textContent;
            document.getElementById("updateStaffRole").value = tr.cells[3].textContent;
            new bootstrap.Modal(document.getElementById("updateStaffModal")).show();
        }
    });

    // Submit Update
    document.getElementById("updateStaffForm").addEventListener("submit", e => {
        e.preventDefault();
        const id = document.getElementById("updateStaffId").value;
        const name = document.getElementById("updateStaffName").value;
        const email = document.getElementById("updateStaffEmail").value;
        const role = document.getElementById("updateStaffRole").value;

        fetch(`/staff/update/${id}`, {
            method: "PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({name,email,role})
        }).then(() => {
            fetchStaff();
            bootstrap.Modal.getInstance(document.getElementById("updateStaffModal")).hide();
        });
    });

    // Filter by name
    const staffFilter = document.getElementById("staffFilter");
    staffFilter.addEventListener('keyup', function() {
        const filter = staffFilter.value.toLowerCase();
        document.querySelectorAll('#staffTable tr').forEach(row => {
            const name = row.cells[1].textContent.toLowerCase();
            row.style.display = name.includes(filter) ? '' : 'none';
        });
    });

    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    const wrapper = document.getElementById('wrapper');
    sidebarToggle.addEventListener('click', () => {
        wrapper.classList.toggle('toggled');
    });
});
</script>
</body>
</html>
